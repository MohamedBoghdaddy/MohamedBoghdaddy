name: Update GitHub Cards

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install SVG to PNG converter
        run: |
          sudo apt-get update
          sudo apt-get install -y librsvg2-bin

      - name: Download cards (with fallback)
        shell: bash
        run: |
          mkdir -p profile
          UA="Mozilla/5.0 (GitHub Actions)"

          fetch_svg () {
            local out="$1"; shift
            local ok=0

            for url in "$@"; do
              echo "Trying: $url"
              if curl -L -A "$UA" --connect-timeout 15 --max-time 60 \
                --retry 3 --retry-delay 2 --retry-all-errors \
                "$url" -o "$out.tmp"; then

                if grep -qi "<svg" "$out.tmp"; then
                  mv "$out.tmp" "$out"
                  echo "✅ Saved: $out"
                  ok=1
                  break
                else
                  echo "⚠️ Not SVG response from $url"
                fi
              else
                echo "⚠️ Failed: $url"
              fi
            done

            rm -f "$out.tmp"

            if [ "$ok" -ne 1 ]; then
              if [ -f "$out" ]; then
                echo "✅ Keeping existing $out (service down / rate-limited)"
              else
                echo "⚠️ No existing $out found (first run). Creating placeholder SVG."
                echo '<svg xmlns="http://www.w3.org/2000/svg" width="520" height="90"><rect width="100%" height="100%" fill="#111"/><text x="14" y="52" fill="#fff" font-size="16" font-family="Arial">Stats temporarily unavailable — will auto-refresh later</text></svg>' > "$out"
              fi
            fi
          }

          # Streak
          fetch_svg "profile/streak.svg" \
            "https://streak-stats.demolab.com?user=MohamedBoghdaddy&theme=dark&hide_border=true"

          # Stats (primary + mirror)
          fetch_svg "profile/stats.svg" \
            "https://github-readme-stats.vercel.app/api?username=MohamedBoghdaddy&show_icons=true&theme=dark&hide_border=true&rank_icon=github&cache_seconds=86400" \
            "https://github-readme-stats-git-masterrstaa-rickstaa.vercel.app/api?username=MohamedBoghdaddy&show_icons=true&theme=dark&hide_border=true&rank_icon=github&cache_seconds=86400"

          # Top Langs (primary + mirror)
          fetch_svg "profile/top-langs.svg" \
            "https://github-readme-stats.vercel.app/api/top-langs/?username=MohamedBoghdaddy&layout=compact&theme=dark&hide_border=true&cache_seconds=86400" \
            "https://github-readme-stats-git-masterrstaa-rickstaa.vercel.app/api/top-langs/?username=MohamedBoghdaddy&layout=compact&theme=dark&hide_border=true&cache_seconds=86400"

      - name: Convert SVG to PNG (GitHub-safe)
        shell: bash
        run: |
          rsvg-convert profile/streak.svg -o profile/streak.png
          rsvg-convert profile/stats.svg -o profile/stats.png
          rsvg-convert profile/top-langs.svg -o profile/top-langs.png

      - name: Commit and push
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # commit both svg + png (or you can delete svg later if you want)
          git add profile/*.svg profile/*.png

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore: update GitHub cards"
          git push
